<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PPE Safety Monitoring Dashboard - Construction Site Safety</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      :root {
        --primary: #3b82f6;
        --primary-dark: #1e40af;
        --secondary: #10b981;
        --danger: #ef4444;
        --warning: #f59e0b;
        --dark: #0f1419;
        --dark-card: #1a1f2e;
        --dark-card-hover: #232837;
        --text-light: #e2e8f0;
        --text-muted: #94a3b8;
        --border-radius: 12px;
        --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        --shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        --shadow-hover: 0 15px 40px rgba(0, 0, 0, 0.4);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: var(--dark);
        color: var(--text-light);
        overflow-x: hidden;
        line-height: 1.6;
      }

      /* Header Styles */
      .header {
        background: linear-gradient(
          135deg,
          var(--primary-dark) 0%,
          var(--primary) 100%
        );
        padding: 1rem 2rem;
        box-shadow: var(--shadow);
        position: sticky;
        top: 0;
        z-index: 1000;
        backdrop-filter: blur(10px);
      }

      .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        max-width: 1800px;
        margin: 0 auto;
      }

      .logo {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .logo i {
        font-size: 2.2rem;
        color: #fbbf24;
        transition: var(--transition);
        text-shadow: 0 0 15px rgba(251, 191, 36, 0.5);
      }

      .logo:hover i {
        transform: rotate(15deg);
      }

      .logo h1 {
        font-size: 1.6rem;
        font-weight: 700;
        background: linear-gradient(to right, #fff, #fbbf24);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      .status-indicators {
        display: flex;
        gap: 1.5rem;
        align-items: center;
      }

      .status-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.6rem 1.2rem;
        border-radius: var(--border-radius);
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(5px);
        transition: var(--transition);
        border: 1px solid transparent;
      }

      .status-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }

      .status-active {
        background: rgba(34, 197, 94, 0.2);
        border: 1px solid #22c55e;
      }

      .status-warning {
        background: rgba(245, 158, 11, 0.2);
        border: 1px solid #f59e0b;
      }

      /* Main Container */
      .main-container {
        max-width: 1800px;
        margin: 0 auto;
        padding: 2rem;
        display: grid;
        grid-template-columns: 1fr 380px;
        gap: 2rem;
        min-height: calc(100vh - 100px);
      }

      .left-panel {
        display: flex;
        flex-direction: column;
        gap: 2rem;
      }

      .right-panel {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
      }

      /* Card Styles */
      .card {
        background: linear-gradient(145deg, var(--dark-card) 0%, #2d3748 100%);
        border-radius: var(--border-radius);
        padding: 1.8rem;
        box-shadow: var(--shadow);
        border: 1px solid rgba(255, 255, 255, 0.08);
        transition: var(--transition);
        overflow: hidden;
        position: relative;
        height: 100%;
      }

      .card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 4px;
        background: linear-gradient(to right, var(--primary), var(--secondary));
        transform: scaleX(0);
        transform-origin: left;
        transition: transform 0.5s ease;
      }

      .card:hover::before {
        transform: scaleX(1);
      }

      .card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-hover);
        border-color: rgba(255, 255, 255, 0.15);
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .card-title {
        font-size: 1.3rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.7rem;
      }

      .card-title i {
        color: var(--primary);
      }

      /* Stats Grid */
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1.2rem;
        margin-bottom: 2rem;
      }

      .stat-card {
        background: linear-gradient(145deg, #2d3748 0%, #4a5568 100%);
        padding: 1.8rem 1.5rem;
        border-radius: var(--border-radius);
        text-align: center;
        border: 1px solid rgba(255, 255, 255, 0.1);
        transition: var(--transition);
        position: relative;
        overflow: hidden;
      }

      .stat-card::after {
        content: "";
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: linear-gradient(
          to right,
          transparent,
          rgba(255, 255, 255, 0.1),
          transparent
        );
        transform: rotate(45deg);
        transition: all 0.5s ease;
        opacity: 0;
      }

      .stat-card:hover::after {
        opacity: 1;
        animation: shimmer 1.5s infinite;
      }

      .stat-card:hover {
        transform: translateY(-8px);
        box-shadow: var(--shadow-hover);
      }

      .stat-value {
        font-size: 2.8rem;
        font-weight: 800;
        margin-bottom: 0.5rem;
        background: linear-gradient(to right, #fff, var(--text-light));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      .stat-label {
        font-size: 0.9rem;
        opacity: 0.8;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--text-muted);
      }

      /* Camera Feeds */
      .cameras-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1.5rem;
        flex: 1;
      }

      .camera-feed {
        background: #000;
        border-radius: var(--border-radius);
        position: relative;
        aspect-ratio: 16/9;
        overflow: hidden;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        transition: var(--transition);
      }

      .camera-feed:hover {
        transform: scale(1.02);
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.6);
      }

      .camera-video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: var(--transition);
      }

      .camera-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
          to bottom,
          rgba(0, 0, 0, 0.7) 0%,
          transparent 30%,
          transparent 70%,
          rgba(0, 0, 0, 0.7) 100%
        );
        pointer-events: none;
      }

      .camera-info {
        position: absolute;
        top: 1rem;
        left: 1rem;
        background: rgba(0, 0, 0, 0.8);
        padding: 0.6rem 1.2rem;
        border-radius: 30px;
        font-size: 0.85rem;
        backdrop-filter: blur(5px);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .camera-status {
        position: absolute;
        top: 1rem;
        right: 1rem;
        width: 14px;
        height: 14px;
        border-radius: 50%;
        background: #22c55e;
        animation: pulse 2s infinite;
        box-shadow: 0 0 10px #22c55e;
      }

      .worker-count {
        position: absolute;
        bottom: 1rem;
        left: 1rem;
        background: rgba(0, 0, 0, 0.8);
        padding: 0.6rem 1.2rem;
        border-radius: 30px;
        font-size: 0.85rem;
        backdrop-filter: blur(5px);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .detection-overlay {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 80%;
        height: 60%;
        border: 2px solid var(--danger);
        border-radius: var(--border-radius);
        background: rgba(239, 68, 68, 0.1);
        display: flex;
        align-items: center;
        justify-content: center;
        animation: detection-blink 1.5s infinite;
        backdrop-filter: blur(2px);
      }

      /* Violation Alerts */
      .violation-alerts {
        max-height: 400px;
        overflow-y: auto;
      }

      .alert-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1.2rem;
        margin-bottom: 0.8rem;
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid var(--danger);
        border-radius: var(--border-radius);
        transition: var(--transition);
        cursor: pointer;
      }

      .alert-item:hover {
        background: rgba(239, 68, 68, 0.2);
        transform: translateX(5px);
      }

      .alert-icon {
        width: 45px;
        height: 45px;
        background: var(--danger);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        transition: var(--transition);
      }

      .alert-item:hover .alert-icon {
        transform: scale(1.1) rotate(10deg);
      }

      .alert-content {
        flex: 1;
      }

      .alert-title {
        font-weight: 600;
        margin-bottom: 0.3rem;
      }

      .alert-details {
        font-size: 0.9rem;
        opacity: 0.8;
        margin-bottom: 0.3rem;
      }

      .alert-time {
        font-size: 0.8rem;
        opacity: 0.6;
      }

      /* Buttons */
      .control-panel {
        display: flex;
        gap: 1rem;
        margin-top: 1rem;
      }

      .btn {
        padding: 0.9rem 1.8rem;
        border: none;
        border-radius: var(--border-radius);
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: 0.7rem;
        position: relative;
        overflow: hidden;
      }

      .btn::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.2),
          transparent
        );
        transition: 0.5s;
      }

      .btn:hover::before {
        left: 100%;
      }

      .btn-primary {
        background: linear-gradient(
          135deg,
          var(--primary),
          var(--primary-dark)
        );
        color: white;
      }

      .btn-primary:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
      }

      .btn-danger {
        background: linear-gradient(135deg, var(--danger), #dc2626);
        color: white;
      }

      .btn-danger:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4);
      }

      .btn-success {
        background: linear-gradient(135deg, var(--secondary), #16a34a);
        color: white;
      }

      .btn-success:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(34, 197, 94, 0.4);
      }

      /* Badges */
      .violation-badge {
        display: inline-block;
        padding: 0.4rem 1rem;
        border-radius: 30px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .badge-helmet {
        background: rgba(239, 68, 68, 0.2);
        color: #fca5a5;
        border: 1px solid var(--danger);
      }

      .badge-vest {
        background: rgba(245, 158, 11, 0.2);
        color: #fcd34d;
        border: 1px solid var(--warning);
      }

      .badge-zone {
        background: rgba(168, 85, 247, 0.2);
        color: #c4b5fd;
        border: 1px solid #a855f7;
      }

      /* Analytics */
      .analytics-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
        height: 300px;
      }

      .chart-container {
        position: relative;
        height: 520px;
        background: rgba(0, 0, 0, 0.2);
        border-radius: var(--border-radius);
        padding: 1rem;
        border: 1px solid rgba(255, 255, 255, 0.1);
        transition: var(--transition);
      }

      .chart-container:hover {
        border-color: rgba(255, 255, 255, 0.2);
        background: rgba(0, 0, 0, 0.25);
      }

      .chart-title {
        text-align: center;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
        color: var(--text-muted);
      }

      /* Notification Badge */
      .notification-badge {
        position: absolute;
        top: -8px;
        right: -8px;
        background: var(--danger);
        color: white;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        font-weight: 700;
        animation: pulse 1.5s infinite;
        box-shadow: 0 0 10px var(--danger);
      }

      /* Animations */
      @keyframes pulse {
        0% {
          transform: scale(1);
          opacity: 1;
        }
        50% {
          transform: scale(1.1);
          opacity: 0.8;
        }
        100% {
          transform: scale(1);
          opacity: 1;
        }
      }

      @keyframes detection-blink {
        0% {
          opacity: 0.8;
          box-shadow: 0 0 20px var(--danger);
        }
        50% {
          opacity: 0.3;
          box-shadow: 0 0 10px var(--danger);
        }
        100% {
          opacity: 0.8;
          box-shadow: 0 0 20px var(--danger);
        }
      }

      @keyframes shimmer {
        0% {
          transform: translateX(-100%) rotate(45deg);
        }
        100% {
          transform: translateX(100%) rotate(45deg);
        }
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateX(-30px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Scrollbar */
      .scrollbar-custom::-webkit-scrollbar {
        width: 8px;
      }

      .scrollbar-custom::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 4px;
      }

      .scrollbar-custom::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 4px;
      }

      .scrollbar-custom::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      /* Responsive Design */
      @media (max-width: 1400px) {
        .main-container {
          grid-template-columns: 1fr 320px;
          gap: 1.5rem;
          padding: 1.5rem;
        }

        .stats-grid {
          grid-template-columns: repeat(2, 1fr);
        }

        .analytics-container {
          grid-template-columns: 1fr;
          height: auto;
        }

        .chart-container {
          height: 280px;
        }
      }

      @media (max-width: 1200px) {
        .main-container {
          grid-template-columns: 1fr;
        }

        .cameras-grid {
          grid-template-columns: 1fr;
        }

        .stats-grid {
          grid-template-columns: repeat(4, 1fr);
        }
      }

      @media (max-width: 992px) {
        .stats-grid {
          grid-template-columns: repeat(2, 1fr);
        }

        .header-content {
          flex-direction: column;
          gap: 1rem;
          text-align: center;
        }

        .status-indicators {
          justify-content: center;
          flex-wrap: wrap;
        }

        .analytics-container {
          grid-template-columns: 1fr;
        }
      }

      @media (max-width: 768px) {
        .main-container {
          padding: 1rem;
        }

        .card {
          padding: 1.5rem;
        }

        .stats-grid {
          grid-template-columns: 1fr;
        }

        .control-panel {
          flex-direction: column;
        }

        .btn {
          width: 100%;
          justify-content: center;
        }

        .analytics-container {
          grid-template-columns: 1fr;
        }
      }

      @media (max-width: 576px) {
        .header {
          padding: 1rem;
        }

        .logo h1 {
          font-size: 1.4rem;
        }

        .status-item {
          padding: 0.5rem 1rem;
          font-size: 0.9rem;
        }

        .card-title {
          font-size: 1.2rem;
        }

        .stat-value {
          font-size: 2.2rem;
        }
      }

      /* Toast notifications */
      .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .toast {
        padding: 1rem 1.5rem;
        border-radius: var(--border-radius);
        background: var(--dark-card);
        color: white;
        box-shadow: var(--shadow);
        display: flex;
        align-items: center;
        gap: 0.8rem;
        animation: toastIn 0.3s ease, toastOut 0.3s ease 2.7s forwards;
        transform: translateX(100%);
        opacity: 0;
        border-left: 4px solid var(--primary);
      }

      .toast.error {
        border-left-color: var(--danger);
      }

      .toast.success {
        border-left-color: var(--secondary);
      }

      .toast.warning {
        border-left-color: var(--warning);
      }

      @keyframes toastIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      @keyframes toastOut {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(100%);
          opacity: 0;
        }
      }

      /* Loading animation */
      .loading-bar {
        position: fixed;
        top: 0;
        left: 0;
        height: 3px;
        background: linear-gradient(to right, var(--primary), var(--secondary));
        width: 0%;
        z-index: 9999;
        transition: width 0.4s ease;
      }

      /* Chart controls */
      .chart-controls {
        display: flex;
        gap: 0.5rem;
        justify-content: center;
        margin-top: 0.5rem;
      }

      .chart-btn {
        padding: 0.4rem 0.8rem;
        background: rgba(255, 255, 255, 0.1);
        border: none;
        border-radius: 4px;
        color: var(--text-light);
        cursor: pointer;
        font-size: 0.8rem;
        transition: var(--transition);
      }

      .chart-btn:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      .chart-btn.active {
        background: var(--primary);
        color: white;
      }
    </style>
  </head>
  <body>
    <div class="loading-bar" id="loadingBar"></div>

    <header class="header">
      <div class="header-content">
        <div class="logo">
          <i class="fas fa-hard-hat"></i>
          <h1>PPE Safety Monitor</h1>
        </div>
        <div class="status-indicators">
          <div class="status-item status-active">
            <i class="fas fa-circle"></i>
            <span>System Active</span>
          </div>
          <div class="status-item">
            <i class="fas fa-video"></i>
            <span id="hdrCams">0 Cameras Online</span>
          </div>
          <div class="status-item status-warning" style="position: relative">
            <i class="fas fa-exclamation-triangle"></i>
            <span>Alerts</span>
            <div class="notification-badge" id="hdrAlertsBadge">0</div>
          </div>
        </div>
      </div>
    </header>

    <div class="main-container">
      <div class="left-panel">
        <!-- Statistics Overview -->
        <div class="stats-grid">
          <div class="stat-card animate__animated animate__fadeInLeft">
            <div class="stat-value" style="color: #22c55e">847</div>
            <div class="stat-label">Workers Detected</div>
          </div>
          <div
            class="stat-card animate__animated animate__fadeInLeft animate__delay-1s"
          >
            <div class="stat-value" style="color: #ef4444">23</div>
            <div class="stat-label">Total Violations</div>
          </div>
          <div
            class="stat-card animate__animated animate__fadeInRight animate__delay-2s"
          >
            <div class="stat-value" style="color: #f59e0b">3</div>
            <div class="stat-label">Active Alerts</div>
          </div>
          <div
            class="stat-card animate__animated animate__fadeInRight animate__delay-3s"
          >
            <div class="stat-value" style="color: #3b82f6">96.4%</div>
            <div class="stat-label">Compliance Rate</div>
          </div>
        </div>

        <!-- Live Camera Feeds -->
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">
              <i class="fas fa-video"></i>
              Live Camera Feeds (YouTube)
            </h2>
            <div class="control-panel" style="align-items: center">
              <button class="btn btn-primary" onclick="startAllFixed()">
                <i class="fas fa-play"></i>
                Start All
              </button>
              <button class="btn btn-danger" onclick="stopAllFixed()">
                <i class="fas fa-stop"></i>
                Stop All
              </button>
            </div>
          </div>
          <div class="cameras-grid">
            <div class="camera-feed">
              <div class="camera-info">Camera 01</div>
              <div class="camera-status" id="fixed1_status"></div>
              <img id="fixed1_img" class="camera-video" style="object-fit: contain; background:#000" />
              <div style="position:absolute; bottom:10px; left:10px; display:flex; gap:0.4rem">
                <input id="fixedSrc1" placeholder="0 or rtsp:// or C:\\video.mp4" value="https://www.youtube.com/watch?v=KIZ_qaxaYG0" style="padding:0.3rem 0.5rem; border-radius:6px; border:1px solid rgba(255,255,255,0.2); background:rgba(0,0,0,0.4); color:#e2e8f0; width:260px" />
                <button class="btn btn-primary" onclick="startFixedCam(1)"><i class="fas fa-play"></i> Start</button>
                <button class="btn btn-danger" onclick="stopFixedCam(1)"><i class="fas fa-stop"></i> Stop</button>
              </div>
            </div>

            <div class="camera-feed">
              <div class="camera-info">Camera 02</div>
              <div class="camera-status" id="fixed2_status"></div>
              <img id="fixed2_img" class="camera-video" style="object-fit: contain; background:#000" />
              <div style="position:absolute; bottom:10px; left:10px; display:flex; gap:0.4rem">
                <input id="fixedSrc2" placeholder="0 or rtsp:// or C:\\video.mp4" value="https://www.youtube.com/watch?v=1I26M3ecCso" style="padding:0.3rem 0.5rem; border-radius:6px; border:1px solid rgba(255,255,255,0.2); background:rgba(0,0,0,0.4); color:#e2e8f0; width:260px" />
                <button class="btn btn-primary" onclick="startFixedCam(2)"><i class="fas fa-play"></i> Start</button>
                <button class="btn btn-danger" onclick="stopFixedCam(2)"><i class="fas fa-stop"></i> Stop</button>
              </div>
            </div>

            <div class="camera-feed">
              <div class="camera-info">Camera 03</div>
              <div class="camera-status" id="fixed3_status"></div>
              <img id="fixed3_img" class="camera-video" style="object-fit: contain; background:#000" />
              <div style="position:absolute; bottom:10px; left:10px; display:flex; gap:0.4rem">
                <input id="fixedSrc3" placeholder="0 or rtsp:// or C:\\video.mp4" value="https://www.youtube.com/watch?v=QXFbAhEiCHw" style="padding:0.3rem 0.5rem; border-radius:6px; border:1px solid rgba(255,255,255,0.2); background:rgba(0,0,0,0.4); color:#e2e8f0; width:260px" />
                <button class="btn btn-primary" onclick="startFixedCam(3)"><i class="fas fa-play"></i> Start</button>
                <button class="btn btn-danger" onclick="stopFixedCam(3)"><i class="fas fa-stop"></i> Stop</button>
              </div>
            </div>

            <div class="camera-feed">
              <div class="camera-info">Camera 04</div>
              <div class="camera-status" id="fixed4_status"></div>
              <img id="fixed4_img" class="camera-video" style="object-fit: contain; background:#000" />
              <div style="position:absolute; bottom:10px; left:10px; display:flex; gap:0.4rem">
                <input id="fixedSrc4" placeholder="0 or rtsp:// or C:\\video.mp4" value="https://www.youtube.com/watch?v=rmutdE17nlc" style="padding:0.3rem 0.5rem; border-radius:6px; border:1px solid rgba(255,255,255,0.2); background:rgba(0,0,0,0.4); color:#e2e8f0; width:260px" />
                <button class="btn btn-primary" onclick="startFixedCam(4)"><i class="fas fa-play"></i> Start</button>
                <button class="btn btn-danger" onclick="stopFixedCam(4)"><i class="fas fa-stop"></i> Stop</button>
              </div>
            </div>
        </div>
        </div>

        <!-- Live Inference (WebSocket) -->
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">
              <i class="fas fa-broadcast-tower"></i>
              Live Inference
            </h2>
            <div class="control-panel" style="align-items: center">
              <input
                id="liveSource"
                type="text"
                placeholder="0 (webcam) or RTSP/HTTP URL"
                style="
                  flex: 1;
                  padding: 0.6rem 0.8rem;
                  border-radius: 8px;
                  border: 1px solid rgba(255, 255, 255, 0.2);
                  background: rgba(0, 0, 0, 0.2);
                  color: var(--text-light);
                "
              />
              <button class="btn btn-primary" onclick="startLive()">
                <i class="fas fa-play"></i>
                Start
              </button>
              <button class="btn btn-danger" onclick="stopLive()">
                <i class="fas fa-stop"></i>
                Stop
              </button>
            </div>
          </div>
          <div>
            <div style="margin-bottom: 0.5rem; color: var(--text-muted)">
              Status:
              <span id="liveStatus" style="color: #ef4444">Offline</span>
            </div>
            <img
              id="liveImg"
              alt="live"
              style="
                width: 100%;
                max-height: 480px;
                object-fit: contain;
                background: #000;
                border-radius: 8px;
                display: none;
              "
            />
          </div>
        </div>

        <!-- Analytics Section -->
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">
              <i class="fas fa-chart-line"></i>
              Safety Analytics
            </h2>
            <div class="chart-controls">
              <button class="chart-btn active" data-chart="compliance">
                Compliance
              </button>
              <button class="chart-btn" data-chart="violations">
                Violations
              </button>
              <button class="chart-btn" data-chart="trend">Trend</button>
            </div>
          </div>
          <div class="analytics-container">
            <div class="chart-container">
              <div class="chart-title">PPE Compliance Rate</div>
              <canvas id="complianceChart"></canvas>
              <div class="chart-controls">
                <button class="chart-btn" onclick="refreshAnalytics()">
                  Refresh Analytics
                </button>
                <a class="chart-btn" href="http://127.0.0.1:8000/reports/events.csv" target="_blank">Export CSV</a>
                <a class="chart-btn" href="http://127.0.0.1:8000/reports/summary.pdf" target="_blank">Download PDF</a>
              </div>
            </div>
            <div class="chart-container">
              <div class="chart-title">Violations by Type</div>
              <canvas id="violationChart"></canvas>
            </div>
          </div>
        </div>
      </div>

      <div class="right-panel">
        <!-- Dynamic Multi-Camera (WebSocket) -->
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">
              <i class="fas fa-video"></i>
              Live Cameras (Dynamic)
            </h2>
            <div class="control-panel" style="align-items: center">
              <input
                id="multiSource"
                type="text"
                placeholder="0 or rtsp://..."
                style="
                  flex: 1;
                  padding: 0.6rem 0.8rem;
                  border-radius: 8px;
                  border: 1px solid rgba(255, 255, 255, 0.2);
                  background: rgba(0, 0, 0, 0.2);
                  color: var(--text-light);
                "
              />
              <button class="btn btn-primary" onclick="addCameraTile()">
                <i class="fas fa-plus"></i>
                Add Camera
              </button>
            </div>
          </div>
          <div class="cameras-grid" id="liveCamerasGrid"></div>
        </div>

        <!-- Sources & Presets -->
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">
              <i class="fas fa-list-ul"></i>
              Sources & Presets
            </h2>
          </div>
          <div class="control-panel" style="flex-direction: column; gap: 0.6rem">
            <div style="display:flex; gap:0.6rem; width:100%">
              <input id="presetSrc" placeholder="rtsp:// or https://youtube..." style="flex:1; padding:0.6rem; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:rgba(0,0,0,0.2); color:var(--text-light)" />
              <button class="btn btn-primary" onclick="saveSourcePreset()"><i class="fas fa-bookmark"></i> Save</button>
            </div>
            <div id="presetList" style="display:flex; flex-direction:column; gap:0.4rem"></div>
          </div>
        </div>

        <!-- Live Data Settings -->
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">
              <i class="fas fa-sliders-h"></i>
              Live Data Settings
            </h2>
          </div>
          <div class="control-panel" style="gap:1rem; align-items:center">
            <label style="display:flex; gap:0.5rem; align-items:center">
              <input id="autoSyncToggle" type="checkbox" checked /> Auto-sync violations
            </label>
            <label style="display:flex; gap:0.5rem; align-items:center">
              <input id="autoAnalyticsToggle" type="checkbox" checked /> Auto-refresh analytics
            </label>
            <button class="btn btn-success" onclick="syncFromBackend(true)"><i class="fas fa-sync"></i> Sync now</button>
            <button class="btn btn-success" onclick="refreshAnalytics(true)"><i class="fas fa-chart-bar"></i> Refresh now</button>
          </div>
        </div>

        <!-- Auth -->
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">
              <i class="fas fa-user-shield"></i>
              Authentication
            </h2>
          </div>
          <div class="control-panel" style="flex-direction: column; gap: 0.5rem">
            <input id="authUser" placeholder="username" style="padding: 0.6rem; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.2); color: var(--text-light);" />
            <input id="authPass" type="password" placeholder="password" style="padding: 0.6rem; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.2); color: var(--text-light);" />
            <div style="display:flex; gap:0.5rem">
              <button class="btn btn-primary" onclick="login()"><i class="fas fa-sign-in-alt"></i> Login</button>
              <button class="btn btn-danger" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </div>
            <div id="authStatus" style="color: var(--text-muted)">Not logged in</div>
          </div>
        </div>

        <!-- Zones & Rules Config -->
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">
              <i class="fas fa-draw-polygon"></i>
              Zones & Rules
            </h2>
          </div>
          <div class="control-panel" style="flex-direction: column; gap: 0.6rem">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 0.6rem; width:100%">
              <input id="zoneSource" placeholder="source (e.g., 0)" style="padding: 0.6rem; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.2); color: var(--text-light);" />
              <input id="zoneName" placeholder="zone name" style="padding: 0.6rem; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.2); color: var(--text-light);" />
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 0.6rem; width:100%">
              <select id="zoneType" style="padding:0.6rem; border-radius:8px; background: rgba(0,0,0,0.2); color:var(--text-light); border: 1px solid rgba(255,255,255,0.2)">
                <option value="no_go">no_go</option>
                <option value="info">info</option>
              </select>
              <input id="dwellSeconds" placeholder="dwell seconds (optional)" style="padding: 0.6rem; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.2); color: var(--text-light);" />
            </div>
            <textarea id="zonePolygon" rows="3" placeholder='polygon JSON (e.g., [[0.1,0.1],[0.4,0.1],[0.4,0.4],[0.1,0.4]])' style="width:100%; padding:0.6rem; border-radius:8px; background: rgba(0,0,0,0.2); color: var(--text-light); border: 1px solid rgba(255,255,255,0.2)"></textarea>
            <div style="display:flex; gap:0.6rem">
              <button class="btn btn-primary" onclick="createZone()"><i class="fas fa-plus-circle"></i> Create Zone</button>
              <button class="btn btn-success" onclick="loadZones()"><i class="fas fa-sync"></i> Load Zones</button>
              <button class="btn btn-warning" onclick="updateRules()"><i class="fas fa-tools"></i> Update Rules</button>
            </div>
            <div style="display:flex; gap:0.6rem">
              <label style="display:flex; align-items:center; gap:0.4rem"><input id="ruleHelmet" type="checkbox" /> require_helmet</label>
              <label style="display:flex; align-items:center; gap:0.4rem"><input id="ruleVest" type="checkbox" /> require_vest</label>
              <label style="display:flex; align-items:center; gap:0.4rem"><input id="privacyBlur" type="checkbox" /> face_blur</label>
            </div>
            <div id="zonesList" style="max-height:160px; overflow:auto; width:100%; background: rgba(0,0,0,0.2); border:1px solid rgba(255,255,255,0.1); border-radius:8px; padding:0.6rem"></div>
          </div>
        </div>

        <!-- Quick inference upload (local testing) -->
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">
              <i class="fas fa-upload"></i>
              Run Model (upload image)
            </h2>
          </div>
          <div style="display: flex; flex-direction: column; gap: 0.8rem">
            <input
              id="modelFileInput"
              type="file"
              accept="image/*"
              onchange="handleFileInput(event)"
            />
            <div style="display: flex; gap: 0.8rem; align-items: center">
              <img
                id="previewInput"
                src=""
                alt="preview"
                style="
                  width: 140px;
                  height: 80px;
                  object-fit: cover;
                  border-radius: 8px;
                  background: #111;
                  display: none;
                "
              />
              <button class="btn btn-primary" onclick="uploadAndPredict()">
                Upload & Predict
              </button>
            </div>
            <div style="display: flex; gap: 0.8rem; align-items: flex-start">
              <div style="flex: 1">
                <div
                  style="
                    font-size: 0.85rem;
                    color: var(--text-muted);
                    margin-bottom: 0.4rem;
                  "
                >
                  Annotated result
                </div>
                <img
                  id="resultImg"
                  src=""
                  alt="result"
                  style="
                    width: 100%;
                    max-height: 240px;
                    object-fit: contain;
                    background: #000;
                    border-radius: 8px;
                    display: none;
                  "
                />
              </div>
            </div>
            <pre
              id="predJson"
              style="
                max-height: 140px;
                overflow: auto;
                background: rgba(0, 0, 0, 0.3);
                padding: 0.6rem;
                border-radius: 8px;
                color: var(--text-muted);
                display: none;
              "
            ></pre>
          </div>
        </div>
        <!-- Real-time Violations -->
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">
              <i class="fas fa-exclamation-triangle"></i>
              Active Violations
              <span class="notification-badge" id="violationBadge">3</span>
            </h2>
            <div class="control-panel">
              <button class="btn btn-success" onclick="syncFromBackend()">
                <i class="fas fa-cloud-download-alt"></i>
                Sync from Backend
              </button>
              <button class="btn btn-danger" onclick="clearAlerts()">
                <i class="fas fa-broom"></i>
                Clear All
              </button>
            </div>
          </div>
          <div class="violation-alerts scrollbar-custom" id="violationList"></div>
        </div>

        <!-- System Controls -->
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">
              <i class="fas fa-cogs"></i>
              System Controls
            </h2>
          </div>
          <div
            class="control-panel"
            style="flex-direction: column; gap: 0.75rem"
          >
            <button class="btn btn-primary" onclick="toggleDetection()">
              <i class="fas fa-eye"></i>
              <span id="detectionBtn">Stop Detection</span>
            </button>
            <button class="btn btn-success" onclick="exportReport()">
              <i class="fas fa-download"></i>
              Export Safety Report
            </button>
          </div>
        </div>

        <!-- Model Performance -->
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">
              <i class="fas fa-brain"></i>
              Model Performance
            </h2>
          </div>
          <div style="display: flex; flex-direction: column; gap: 1rem">
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
              "
            >
              <span>Detection Accuracy (mAP)</span>
              <span style="font-weight: bold; color: #22c55e">0.87</span>
            </div>
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
              "
            >
              <span>Processing Speed (FPS)</span>
              <span style="font-weight: bold; color: #3b82f6">24.3</span>
            </div>
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
              "
            >
              <span>Model: YOLOv8 + DeepSORT</span>
              <span style="color: #22c55e"
                ><i class="fas fa-circle"></i> Active</span
              >
            </div>
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
              "
            >
              <span>GPU Utilization</span>
              <span style="font-weight: bold; color: #f59e0b">67%</span>
            </div>
          </div>
        </div>

        <!-- Quick Stats -->
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">
              <i class="fas fa-tachometer-alt"></i>
              Today's Summary
            </h2>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem">
            <div
              style="
                text-align: center;
                padding: 1rem;
                background: rgba(34, 197, 94, 0.1);
                border-radius: 0.5rem;
                border: 1px solid #22c55e;
              "
            >
              <div style="font-size: 1.5rem; font-weight: bold; color: #22c55e">
                847
              </div>
              <div style="font-size: 0.875rem; opacity: 0.8">Safe Workers</div>
            </div>
            <div
              style="
                text-align: center;
                padding: 1rem;
                background: rgba(239, 68, 68, 0.1);
                border-radius: 0.5rem;
                border: 1px solid #ef4444;
              "
            >
              <div style="font-size: 1.5rem; font-weight: bold; color: #ef4444">
                23
              </div>
              <div style="font-size: 0.875rem; opacity: 0.8">Violations</div>
            </div>
            <div
              style="
                text-align: center;
                padding: 1rem;
                background: rgba(59, 130, 246, 0.1);
                border-radius: 0.5rem;
                border: 1px solid #3b82f6;
              "
            >
              <div style="font-size: 1.5rem; font-weight: bold; color: #3b82f6">
                4
              </div>
              <div style="font-size: 0.875rem; opacity: 0.8">
                Active Cameras
              </div>
            </div>
            <div
              style="
                text-align: center;
                padding: 1rem;
                background: rgba(245, 158, 11, 0.1);
                border-radius: 0.5rem;
                border: 1px solid #f59e0b;
              "
            >
              <div style="font-size: 1.5rem; font-weight: bold; color: #f59e0b">
                8h 45m
              </div>
              <div style="font-size: 0.875rem; opacity: 0.8">Uptime</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="toast-container" id="toastContainer"></div>

    <script>
      let detectionActive = true;
      let violationCount = 3;
      let complianceChart, violationChart;
      let complianceData = {
        labels: ["Helmet", "Vest", "Boots", "Gloves"],
        datasets: [
          {
            label: "Compliance Rate (%)",
            data: [92, 88, 95, 85],
            backgroundColor: [
              "rgba(59, 130, 246, 0.7)",
              "rgba(16, 185, 129, 0.7)",
              "rgba(245, 158, 11, 0.7)",
              "rgba(139, 92, 246, 0.7)",
            ],
            borderColor: [
              "rgb(59, 130, 246)",
              "rgb(16, 185, 129)",
              "rgb(245, 158, 11)",
              "rgb(139, 92, 246)",
            ],
            borderWidth: 1,
          },
        ],
      };

      let violationData = {
        labels: ["Helmet Missing", "Vest Missing", "Zone Violation", "Other"],
        datasets: [
          {
            label: "Violations by Type",
            data: [12, 7, 3, 1],
            backgroundColor: [
              "rgba(239, 68, 68, 0.7)",
              "rgba(245, 158, 11, 0.7)",
              "rgba(139, 92, 246, 0.7)",
              "rgba(107, 114, 128, 0.7)",
            ],
            borderColor: [
              "rgb(239, 68, 68)",
              "rgb(245, 158, 11)",
              "rgb(139, 92, 246)",
              "rgb(107, 114, 128)",
            ],
            borderWidth: 1,
          },
        ],
      };

      // Initialize charts
      function initCharts() {
        const complianceCtx = document
          .getElementById("complianceChart")
          .getContext("2d");
        complianceChart = new Chart(complianceCtx, {
          type: "bar",
          data: complianceData,
          options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: {
              duration: 1000,
              easing: "easeOutQuart",
            },
            scales: {
              y: {
                beginAtZero: true,
                max: 100,
                grid: {
                  color: "rgba(255, 255, 255, 0.1)",
                },
                ticks: {
                  color: "#94a3b8",
                },
              },
              x: {
                grid: {
                  color: "rgba(255, 255, 255, 0.1)",
                },
                ticks: {
                  color: "#94a3b8",
                },
              },
            },
            plugins: {
              legend: {
                labels: {
                  color: "#e2e8f0",
                },
              },
            },
          },
        });

        const violationCtx = document
          .getElementById("violationChart")
          .getContext("2d");
        violationChart = new Chart(violationCtx, {
          type: "doughnut",
          data: violationData,
          options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: {
              duration: 1000,
              easing: "easeOutQuart",
            },
            plugins: {
              legend: {
                position: "bottom",
                labels: {
                  color: "#e2e8f0",
                  padding: 15,
                },
              },
            },
          },
        });
      }

      // Update charts with new data
      function updateCharts() {
        // Simulate data updates
        complianceData.datasets[0].data = complianceData.datasets[0].data.map(
          (value) => {
            const change = Math.random() * 4 - 2; // Random change between -2 and +2
            return Math.max(75, Math.min(100, value + change)); // Keep between 75-100%
          }
        );

        violationData.datasets[0].data = violationData.datasets[0].data.map(
          (value) => {
            const change = Math.floor(Math.random() * 3); // Random change of 0-2
            return Math.max(0, value + change); // Ensure not negative
          }
        );

        complianceChart.update();
        violationChart.update();
      }

      // Simulate page loading
      document.addEventListener("DOMContentLoaded", function () {
        const loadingBar = document.getElementById("loadingBar");
        loadingBar.style.width = "100%";

        setTimeout(() => {
          loadingBar.style.opacity = "0";
          setTimeout(() => {
            loadingBar.style.display = "none";
          }, 500);
        }, 800);

        console.log(" PPE Safety Monitoring Dashboard Initialized");
        console.log(" System Status: Online");
        console.log(" Cameras: 4 Active");
        console.log(" AI Model: YOLOv8 + DeepSORT Running");

        // Initialize charts
        initCharts();
        // Initial real data load and presets
        syncFromBackend();
        refreshAnalytics();
        loadSourcePresets();
        // Setup toggles
        const t1 = document.getElementById("autoSyncToggle");
        const t2 = document.getElementById("autoAnalyticsToggle");
        if (t1) { t1.checked = autoSync; t1.addEventListener("change", () => autoSync = t1.checked); }
        if (t2) { t2.checked = autoAnalytics; t2.addEventListener("change", () => autoAnalytics = t2.checked); }

        // Prefill fixed tiles with first 4 YouTube presets (if empty) and auto-start
        try {
          const raw = localStorage.getItem("savedSources") || "[]";
          let arr = [];
          try { arr = JSON.parse(raw); } catch(e) { arr = []; }
          const slots = [1,2,3,4];
          slots.forEach((slot, idx) => {
            const input = document.getElementById(`fixedSrc${slot}`);
            if (input && !input.value && arr[idx]) {
              input.value = arr[idx];
            }
          });
          startAllFixed();
        } catch (e) { console.error(e); }
        updateHeaderCameras();

        // Show welcome toast
        showToast(
          "System initialized successfully. Monitoring 4 cameras.",
          "success"
        );
      });

      // Real-time polling for backend data
      setInterval(() => { syncFromBackend(); updateHeaderCameras(); }, 5000);
      setInterval(() => { refreshAnalytics(); }, 10000);

      function updateStats() {
        // Simulate worker count updates
        document.querySelectorAll(".worker-count").forEach((el, index) => {
          const count = Math.floor(Math.random() * 15) + 1;
          el.innerHTML = `<i class="fas fa-users"></i> ${count} Workers`;
        });

        // Update processing speed
        const fps = (20 + Math.random() * 10).toFixed(1);
        const performanceCard =
          document.querySelectorAll(".card")[
            document.querySelectorAll(".card").length - 2
          ];
        if (performanceCard) {
          const spans = performanceCard.querySelectorAll("span");
          if (spans.length >= 4) {
            spans[1].textContent = fps;
          }
        }
      }

      function addRandomViolation() {
        if (!detectionActive) return;

        const violations = [
          {
            type: "Helmet Missing",
            badge: "badge-helmet",
            icon: "fas fa-hard-hat",
            worker: "WK-" + Math.floor(Math.random() * 9999),
            camera: "Camera 0" + (Math.floor(Math.random() * 4) + 1),
          },
          {
            type: "Safety Vest Missing",
            badge: "badge-vest",
            icon: "fas fa-shield-alt",
            worker: "WK-" + Math.floor(Math.random() * 9999),
            camera: "Camera 0" + (Math.floor(Math.random() * 4) + 1),
          },
          {
            type: "Unauthorized Zone Entry",
            badge: "badge-zone",
            icon: "fas fa-ban",
            worker: "WK-" + Math.floor(Math.random() * 9999),
            camera: "Camera 0" + (Math.floor(Math.random() * 4) + 1),
          },
        ];

        const violation =
          violations[Math.floor(Math.random() * violations.length)];
        const violationList = document.getElementById("violationList");

        const alertItem = document.createElement("div");
        alertItem.className = "alert-item";
        alertItem.style.animation = "slideIn 0.3s ease";
        alertItem.innerHTML = `
          <div class="alert-icon">
            <i class="${violation.icon}"></i>
          </div>
          <div class="alert-content">
            <div class="alert-title">${violation.type}</div>
            <div class="alert-details">Worker ID: ${violation.worker}  ${
          violation.camera
        }</div>
            <div class="alert-time">Just now</div>
          </div>
          <span class="violation-badge ${violation.badge}">${
          violation.type.split(" ")[0]
        }</span>
        `;

        violationList.insertBefore(alertItem, violationList.firstChild);

        // Update counters
        violationCount++;
        updateViolationBadges();

        // Update violation chart data
        if (violation.type.includes("Helmet")) {
          violationData.datasets[0].data[0] += 1;
        } else if (violation.type.includes("Vest")) {
          violationData.datasets[0].data[1] += 1;
        } else if (violation.type.includes("Zone")) {
          violationData.datasets[0].data[2] += 1;
        } else {
          violationData.datasets[0].data[3] += 1;
        }

        violationChart.update();

        // Show notification
        showToast(`New violation detected: ${violation.type}`, "error");
      }

      function updateViolationBadges() {
        document.querySelectorAll(".notification-badge").forEach((badge) => {
          badge.textContent = violationCount;
        });
      }

      function toggleDetection() {
        const btn = document.getElementById("detectionBtn");
        detectionActive = !detectionActive;

        if (detectionActive) {
          btn.textContent = "Stop Detection";
          btn.parentElement.className = "btn btn-primary";
          showToast("Detection system activated", "success");
        } else {
          btn.textContent = "Start Detection";
          btn.parentElement.className = "btn btn-success";
          showToast("Detection system paused", "warning");
        }
      }

      function clearAlerts() {
        const violationList = document.getElementById("violationList");
        violationList.innerHTML = "";
        violationCount = 0;
        const badge = document.getElementById("violationBadge");
        if (badge) badge.textContent = "0";
        showToast("All alerts cleared", "success");
      }

      function exportReport() {
        // Simulate report generation
        const reportData = {
          date: new Date().toLocaleDateString(),
          totalWorkers: 847,
          totalViolations: 23,
          complianceRate: "96.4%",
          cameras: 4,
          uptime: "8h 45m",
        };

        // Show loading state
        const exportBtn = document.querySelector(".btn-success");
        const originalHtml = exportBtn.innerHTML;
        exportBtn.innerHTML =
          '<i class="fas fa-spinner fa-spin"></i> Generating...';
        exportBtn.disabled = true;

        // Simulate download
        setTimeout(() => {
          exportBtn.innerHTML = originalHtml;
          exportBtn.disabled = false;
          showToast(
            "Safety report has been generated and downloaded successfully!",
            "success"
          );
        }, 2000);
      }

      function triggerEmergency() {
        if (
          confirm(
            "Are you sure you want to trigger an emergency alert? This will notify all safety personnel immediately."
          )
        ) {
          // Visual feedback
          document.body.style.animation = "emergency-flash 0.5s ease-in-out 3";

          // Add emergency alert to violations
          const violationList = document.getElementById("violationList");
          const emergencyAlert = document.createElement("div");
          emergencyAlert.className = "alert-item";
          emergencyAlert.style.background = "rgba(239, 68, 68, 0.3)";
          emergencyAlert.style.border = "2px solid #ef4444";
          emergencyAlert.innerHTML = `
            <div class="alert-icon" style="background: #dc2626;">
              <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="alert-content">
              <div class="alert-title" style="color: #fca5a5;">EMERGENCY ALERT ACTIVATED</div>
              <div class="alert-details">All safety personnel have been notified</div>
              <div class="alert-time">Just now</div>
            </div>
            <span class="violation-badge" style="background: #dc2626; color: white; border: 1px solid #dc2626;">EMERGENCY</span>
          `;

          violationList.insertBefore(emergencyAlert, violationList.firstChild);

          // Show notification
          showToast("Emergency alert sent to all safety personnel!", "error");
        }
      }

      // Toast notification function
      function showToast(message, type = "info") {
        if (type !== "error") return;
        const toastContainer = document.getElementById("toastContainer");
        const toast = document.createElement("div");
        toast.className = `toast ${type}`;

        let icon = "fas fa-info-circle";
        if (type === "error") icon = "fas fa-exclamation-circle";

        toast.innerHTML = `
          <i class="${icon}"></i>
          <span>${message}</span>
        `;

        toastContainer.appendChild(toast);

        // Remove toast after animation completes
        setTimeout(() => {
          toast.remove();
        }, 3000);
      }

      // Camera status will reflect actual WebSocket open/close events

      // Add CSS animation for emergency flash
      const style = document.createElement("style");
      style.textContent = `
        @keyframes emergency-flash {
          0% { background-color: #0f1419; }
          50% { background-color: rgba(239, 68, 68, 0.1); }
          100% { background-color: #0f1419; }
        }
      `;
      document.head.appendChild(style);

      // Keyboard shortcuts
      document.addEventListener("keydown", function (event) {
        if (event.ctrlKey) {
          switch (event.key) {
            case "d":
              event.preventDefault();
              toggleDetection();
              break;
            case "c":
              event.preventDefault();
              clearAlerts();
              break;
            case "e":
              event.preventDefault();
              exportReport();
              break;
          }
        }
      });

      // Add tooltips for better UX
      document.querySelectorAll("[title]").forEach((element) => {
        element.addEventListener("mouseenter", function () {
          this.style.cursor = "help";
        });
      });

      // Performance metrics: no randomization; populate via analytics if desired

      // Chart control buttons
      document.querySelectorAll(".chart-btn").forEach((button) => {
        button.addEventListener("click", function () {
          // Remove active class from all buttons
          document.querySelectorAll(".chart-btn").forEach((btn) => {
            btn.classList.remove("active");
          });

          // Add active class to clicked button
          this.classList.add("active");

          // Here you would typically switch between different chart views
          // For this example, we'll just show a toast notification
          showToast(`Switched to ${this.dataset.chart} view`, "info");
        });
      });

      // -----------------------
      // Simple client -> backend helper
      // -----------------------
      // Resolve API/WS endpoints dynamically to avoid hostname/HTTP(S) mismatches
      const API_HOST = `${location.protocol}//${location.hostname}:8000`;
      const API_URL = `${API_HOST}/predict`;
      const WS_URL = `${location.protocol === 'https:' ? 'wss' : 'ws'}://${location.hostname}:8000/ws`; // websocket live inference
      let wsLive = null;
      const liveCameras = new Map(); // id -> { ws, imgEl, statusEl }
      let authToken = localStorage.getItem("token") || "";
      const fixedCams = new Map(); // slot -> { ws, imgEl, statusEl }
      let autoSync = true;
      let autoAnalytics = true;

      function handleFileInput(e) {
        const file = e.target.files[0];
        const preview = document.getElementById("previewInput");
        if (file) {
          preview.src = URL.createObjectURL(file);
          preview.style.display = "block";
        } else {
          preview.style.display = "none";
        }
      }

      async function predictFromFile(file) {
        const form = new FormData();
        form.append("file", file);

        try {
          showToast("Sending image to backend...", "info");
          const res = await fetch(API_URL, { method: "POST", body: form });
          if (!res.ok) {
            const text = await res.text();
            showToast(`Server error: ${res.status}`, "error");
            console.error(text);
            return;
          }
          const data = await res.json();
          if (data.image) {
            const img = document.getElementById("resultImg");
            img.src = `data:image/png;base64,${data.image}`;
            img.style.display = "block";
            const p = document.getElementById("predJson");
            p.textContent = JSON.stringify(data.predictions || [], null, 2);
            p.style.display = "block";
            showToast("Inference complete", "success");
          } else if (data.error) {
            showToast(`Error: ${data.error}`, "error");
          } else {
            showToast("No annotated image returned", "warning");
          }
        } catch (err) {
          console.error(err);
          showToast(
            "Network or server error. Check backend is running.",
            "error"
          );
        }
      }

      function uploadAndPredict() {
        const input = document.getElementById("modelFileInput");
        if (!input.files || input.files.length === 0) {
          alert("Choose an image first");
          return;
        }
        predictFromFile(input.files[0]);
      }

      // Live inference via WebSocket
      function startLive() {
        try {
          if (wsLive && wsLive.readyState === WebSocket.OPEN) return;

          const srcInput = document.getElementById("liveSource");
          const source = (srcInput && srcInput.value.trim()) || "0";

          wsLive = new WebSocket(WS_URL);

          wsLive.onopen = function () {
            wsLive.send(JSON.stringify({ source }));
            const st = document.getElementById("liveStatus");
            if (st) {
              st.textContent = "Online";
              st.style.color = "#22c55e";
            }
            updateHeaderCameras();
          };

          wsLive.onmessage = function (ev) {
            const img = document.getElementById("liveImg");
            if (img) {
              img.src = "data:image/jpeg;base64," + ev.data;
              img.style.display = "block";
            }
          };

          wsLive.onclose = function () {
            const st = document.getElementById("liveStatus");
            if (st) {
              st.textContent = "Offline";
              st.style.color = "#ef4444";
            }
            updateHeaderCameras();
          };

          wsLive.onerror = function () {
            showToast("Live stream error", "error");
          };
        } catch (e) {
          console.error(e);
          showToast("Could not start live stream", "error");
        }
      }

      function stopLive() {
        try {
          if (wsLive) {
            wsLive.close();
            wsLive = null;
            const st = document.getElementById("liveStatus");
            if (st) {
              st.textContent = "Offline";
              st.style.color = "#ef4444";
            }
            updateHeaderCameras();
          }
        } catch (e) {
          console.error(e);
        }
      }

      // Dynamic multi-camera tiles
      function addCameraTile() {
        const srcInput = document.getElementById("multiSource");
        const source = (srcInput && srcInput.value.trim()) || "0";
        const id = `cam_${Date.now()}`;

        const grid = document.getElementById("liveCamerasGrid");
        const wrap = document.createElement("div");
        wrap.className = "camera-feed";
        wrap.style.position = "relative";
        wrap.innerHTML = `
          <div class="camera-overlay"></div>
          <div class="camera-info">${source}</div>
          <div class="camera-status"></div>
          <img id="${id}_img" class="camera-video" style="object-fit: contain; background:#000" />
          <div style="position:absolute; bottom:10px; right:10px; display:flex; gap:0.4rem">
            <button id="${id}_fs" class="btn btn-primary"><i class="fas fa-expand"></i> Fullscreen</button>
            <button id="${id}_btn" class="btn btn-danger"><i class="fas fa-times"></i> Close</button>
          </div>
        `;
        grid.prepend(wrap);

        const imgEl = wrap.querySelector(`#${id}_img`);
        const btnEl = wrap.querySelector(`#${id}_btn`);
        const fsEl = wrap.querySelector(`#${id}_fs`);
        const statusEl = wrap.querySelector(".camera-status");

        const ws = new WebSocket(WS_URL);
        ws.onopen = function () {
          ws.send(JSON.stringify({ source }));
          statusEl.style.background = "#22c55e";
          updateHeaderCameras();
        };
        ws.onmessage = function (ev) {
          imgEl.src = "data:image/jpeg;base64," + ev.data;
        };
        ws.onclose = function () {
          statusEl.style.background = "#ef4444";
          updateHeaderCameras();
        };
        ws.onerror = function () {
          showToast(`Error on ${source}`, "error");
          statusEl.style.background = "#ef4444";
        };

        btnEl.onclick = function () {
          try {
            ws.close();
          } catch (e) {}
          wrap.remove();
          liveCameras.delete(id);
          updateHeaderCameras();
        };
        fsEl.onclick = function () {
          if (wrap.classList.contains("fullscreen")) {
            wrap.classList.remove("fullscreen");
            wrap.style.zIndex = "";
            wrap.style.position = "relative";
          } else {
            wrap.classList.add("fullscreen");
            wrap.style.position = "fixed";
            wrap.style.zIndex = "2000";
            wrap.style.top = "0";
            wrap.style.left = "0";
            wrap.style.width = "100vw";
            wrap.style.height = "100vh";
          }
        };

        liveCameras.set(id, { ws, imgEl, statusEl });
        updateHeaderCameras();
      }

      // Backend-driven events
      async function syncFromBackend(force = false) {
        if (!force && !autoSync) return;
        try {
          const res = await fetch("http://127.0.0.1:8000/events?limit=20");
          if (!res.ok) throw new Error("Failed to fetch events");
          const data = await res.json();
          const list = document.getElementById("violationList");
          list.innerHTML = "";
          const events = data.events || [];
          document.getElementById("violationBadge").textContent = events.length;
          const hdrAlerts = document.getElementById("hdrAlertsBadge");
          if (hdrAlerts) hdrAlerts.textContent = events.length;

          events.forEach((ev) => {
            const item = document.createElement("div");
            item.className = "alert-item";
            const type = ev.type || "event";
            const track = ev.track_id != null ? `#${ev.track_id}` : "";
            item.innerHTML = `
              <div class="alert-icon"><i class="fas fa-bell"></i></div>
              <div class="alert-content">
                <div class="alert-title">${type.toUpperCase()} ${track}</div>
                <div class="alert-details">Source: ${ev.source}  Class: ${ev.class_id}  Conf: ${(ev.conf||0).toFixed(2)}</div>
                <div class="alert-time">${new Date(ev.ts * 1000).toLocaleTimeString()}</div>
              </div>
              <span class="violation-badge" style="background: rgba(59,130,246,0.2); color:#93c5fd; border:1px solid #3b82f6;">Evt</span>
            `;
            list.appendChild(item);
          });
          showToast("Synced events from backend", "success");
        } catch (e) {
          console.error(e);
          showToast("Failed to sync backend events", "error");
        }
      }

      // Fixed camera helpers
      function startFixedCam(slot) {
        try {
          const src = document.getElementById(`fixedSrc${slot}`);
          const imgEl = document.getElementById(`fixed${slot}_img`);
          const statusEl = document.getElementById(`fixed${slot}_status`);
          if (!src || !imgEl || !statusEl) return;
          const source = (src.value || "0").trim();
          // Close existing
          const existing = fixedCams.get(slot);
          if (existing && existing.ws) {
            try { existing.ws.close(); } catch (e) {}
          }
          const ws = new WebSocket(WS_URL);
          ws.onopen = function () {
            ws.send(JSON.stringify({ source }));
            statusEl.style.background = "#22c55e";
            updateHeaderCameras();
          };
          ws.onmessage = function (ev) {
            imgEl.src = "data:image/jpeg;base64," + ev.data;
          };
          ws.onclose = function () {
            statusEl.style.background = "#ef4444";
            updateHeaderCameras();
          };
          ws.onerror = function () {
            statusEl.style.background = "#ef4444";
            showToast(`Error on ${source}`, "error");
          };
          fixedCams.set(slot, { ws, imgEl, statusEl });
          updateHeaderCameras();
        } catch (e) {
          console.error(e);
          showToast("Failed to start camera", "error");
        }
      }

      function stopFixedCam(slot) {
        const entry = fixedCams.get(slot);
        if (entry && entry.ws) {
          try { entry.ws.close(); } catch (e) {}
          entry.statusEl.style.background = "#ef4444";
          fixedCams.delete(slot);
          updateHeaderCameras();
        }
      }

      function startAllFixed() {
        [1,2,3,4].forEach(startFixedCam);
      }
      function stopAllFixed() {
        [1,2,3,4].forEach(stopFixedCam);
      }

      // Presets
      function loadSourcePresets() {
        const raw = localStorage.getItem("savedSources") || "[]";
        let arr = [];
        try { arr = JSON.parse(raw); } catch(e) { arr = []; }
        const list = document.getElementById("presetList");
        if (!list) return;
        list.innerHTML = "";
        if (!arr.length) {
          const p = document.createElement("div");
          p.style.color = "var(--text-muted)";
          p.textContent = "No saved sources yet.";
          list.appendChild(p);
          return;
        }
        arr.forEach((src, idx) => {
          const row = document.createElement("div");
          row.style.display = "flex";
          row.style.justifyContent = "space-between";
          row.style.alignItems = "center";
          row.style.gap = "0.5rem";
          row.innerHTML = `<div style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:60%">${src}</div>`;
          const controls = document.createElement("div");
          controls.style.display = "flex";
          controls.style.gap = "0.4rem";
          const btnTile = document.createElement("button");
          btnTile.className = "btn btn-primary";
          btnTile.innerHTML = '<i class="fas fa-plus-square"></i>';
          btnTile.title = "Start in new tile";
          btnTile.onclick = () => addCameraTileFromSource(src);
          const btnCam1 = document.createElement("button");
          btnCam1.className = "btn btn-success";
          btnCam1.innerHTML = '<i class="fas fa-video"></i> Cam01';
          btnCam1.onclick = () => { document.getElementById("fixedSrc1").value = src; startFixedCam(1); };
          const btnDel = document.createElement("button");
          btnDel.className = "btn btn-danger";
          btnDel.innerHTML = '<i class="fas fa-trash"></i>';
          btnDel.onclick = () => deleteSourcePreset(idx);
          controls.appendChild(btnTile);
          controls.appendChild(btnCam1);
          controls.appendChild(btnDel);
          row.appendChild(controls);
          list.appendChild(row);
        });
      }

      function saveSourcePreset() {
        const input = document.getElementById("presetSrc");
        const val = (input.value || "").trim();
        if (!val) return;
        const raw = localStorage.getItem("savedSources") || "[]";
        let arr = [];
        try { arr = JSON.parse(raw); } catch(e) { arr = []; }
        if (!arr.includes(val)) {
          arr.push(val);
          localStorage.setItem("savedSources", JSON.stringify(arr));
          showToast("Source saved", "success");
          loadSourcePresets();
        }
        input.value = "";
      }

      function deleteSourcePreset(idx) {
        const raw = localStorage.getItem("savedSources") || "[]";
        let arr = [];
        try { arr = JSON.parse(raw); } catch(e) { arr = []; }
        arr.splice(idx, 1);
        localStorage.setItem("savedSources", JSON.stringify(arr));
        loadSourcePresets();
        showToast("Preset removed", "warning");
      }

      function addCameraTileFromSource(source) {
        const srcInput = document.getElementById("multiSource");
        if (srcInput) srcInput.value = source;
        addCameraTile();
      }

      // Header updates
      function updateHeaderCameras() {
        const total = (wsLive && wsLive.readyState === WebSocket.OPEN ? 1 : 0) + liveCameras.size + fixedCams.size;
        const hdr = document.getElementById("hdrCams");
        if (hdr) hdr.textContent = `${total} Camera${total === 1 ? "" : "s"} Online`;
      }

      // Auth
      async function login() {
        const u = document.getElementById("authUser").value.trim();
        const p = document.getElementById("authPass").value.trim();
        try {
          const res = await fetch("http://127.0.0.1:8000/auth/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username: u, password: p }),
          });
          if (!res.ok) {
            showToast("Login failed", "error");
            return;
          }
          const data = await res.json();
          authToken = data.access_token;
          localStorage.setItem("token", authToken);
          document.getElementById("authStatus").textContent = `Logged in as ${u} (${data.role})`;
          showToast("Logged in", "success");
        } catch (e) {
          showToast("Login error", "error");
        }
      }

      function logout() {
        authToken = "";
        localStorage.removeItem("token");
        document.getElementById("authStatus").textContent = "Not logged in";
        showToast("Logged out", "warning");
      }

      async function refreshAnalytics(force = false) {
        if (!force && !autoAnalytics) return;
        try {
          const res = await fetch("http://127.0.0.1:8000/analytics/summary?days=7");
          if (!res.ok) throw new Error("fetch failed");
          const data = await res.json();
          // Update violation chart by types
          const byType = data.by_type || {};
          const labels = Object.keys(byType);
          const values = labels.map((k) => byType[k]);
          violationChart.data.labels = labels.length ? labels : ["detection", "zone_violation"];
          violationChart.data.datasets[0].data = values.length ? values : [0, 0];
          violationChart.update();
          showToast("Analytics refreshed", "success");
        } catch (e) {
          console.error(e);
          showToast("Analytics refresh failed", "error");
        }
      }

      async function createZone() {
        try {
          const source = document.getElementById("zoneSource").value.trim();
          const name = document.getElementById("zoneName").value.trim();
          const type = document.getElementById("zoneType").value;
          const polygon = JSON.parse(document.getElementById("zonePolygon").value || "[]");
          if (!authToken) {
            showToast("Login required", "warning");
            return;
          }
          const res = await fetch("http://127.0.0.1:8000/zones", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer " + authToken,
            },
            body: JSON.stringify({ source, name, type, polygon }),
          });
          if (!res.ok) throw new Error("create failed");
          showToast("Zone created", "success");
          loadZones();
        } catch (e) {
          console.error(e);
          showToast("Create zone failed", "error");
        }
      }

      async function loadZones() {
        try {
          const res = await fetch("http://127.0.0.1:8000/zones");
          const data = await res.json();
          const list = document.getElementById("zonesList");
          list.innerHTML = "";
          (data.zones || []).forEach((z) => {
            const row = document.createElement("div");
            row.style.display = "flex";
            row.style.justifyContent = "space-between";
            row.style.alignItems = "center";
            row.style.padding = "0.3rem 0";
            row.innerHTML = `<div>#${z.id} [${z.source}] ${z.name} (${z.type})</div>`;
            const btn = document.createElement("button");
            btn.className = "btn btn-danger";
            btn.innerHTML = '<i class="fas fa-trash"></i>';
            btn.onclick = async () => {
              if (!authToken) {
                showToast("Login required", "warning");
                return;
              }
              const r = await fetch("http://127.0.0.1:8000/zones/" + z.id, {
                method: "DELETE",
                headers: { Authorization: "Bearer " + authToken },
              });
              if (r.ok) {
                showToast("Zone deleted", "success");
                loadZones();
              } else {
                showToast("Delete failed", "error");
              }
            };
            row.appendChild(btn);
            list.appendChild(row);
          });
          showToast("Zones loaded", "success");
        } catch (e) {
          console.error(e);
          showToast("Load zones failed", "error");
        }
      }

      async function updateRules() {
        try {
          if (!authToken) {
            showToast("Login required", "warning");
            return;
          }
          const require_helmet = document.getElementById("ruleHelmet").checked;
          const require_vest = document.getElementById("ruleVest").checked;
          const face_blur = document.getElementById("privacyBlur").checked;
          const dwell_seconds = parseInt(document.getElementById("dwellSeconds").value || "0");
          const body = {
            rules: { require_helmet, require_vest, dwell_seconds },
            privacy: { face_blur }
          };
          const res = await fetch("http://127.0.0.1:8000/config", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer " + authToken,
            },
            body: JSON.stringify(body),
          });
          if (!res.ok) throw new Error("failed");
          showToast("Rules updated", "success");
        } catch (e) {
          console.error(e);
          showToast("Rules update failed", "error");
        }
      }
    </script>
  </body>
</html>
